# DaangMatino Supabase Setup Guide

## Prerequisites
1. A Supabase account (sign up at https://supabase.com)
2. Your DaangMatino project files

## Step 1: Create a New Supabase Project

1. Go to https://supabase.com and sign in
2. Click "New Project"
3. Choose your organization
4. Enter project details:
   - Name: `DaangMatino`
   - Database Password: (create a strong password)
   - Region: Choose closest to your location
5. Click "Create new project"

## Step 2: Set Up the Database Schema

1. In your Supabase dashboard, go to the "SQL Editor"
2. Create a new query and paste the following SQL:

```sql
-- Enable UUID extension
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- Create admin table
CREATE TABLE public.admin (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  email character varying NOT NULL UNIQUE,
  role character varying DEFAULT 'admin'::character varying,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT admin_pkey PRIMARY KEY (id)
);

-- Create reports table
CREATE TABLE public.reports (
  id integer NOT NULL GENERATED BY DEFAULT AS IDENTITY,
  public_id character varying DEFAULT ('RPT-'::text || lpad((id)::text, 6, '0'::text)),
  reporter_name character varying,
  reporter_email character varying,
  reporter_phone character varying,
  issue_type character varying NOT NULL CHECK (issue_type::text = ANY (ARRAY['Pothole'::character varying, 'Flooding'::character varying, 'Damaged Road'::character varying, 'Traffic Light Issue'::character varying, 'Road Sign Issue'::character varying, 'Other'::character varying]::text[])),
  date_occurred date,
  time_occurred time without time zone,
  priority character varying NOT NULL CHECK (priority::text = ANY (ARRAY['Low'::character varying, 'Medium'::character varying, 'High'::character varying, 'Critical'::character varying]::text[])),
  location_description text NOT NULL,
  description text NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT reports_pkey PRIMARY KEY (id)
);

-- Create report_attachments table
CREATE TABLE public.report_attachments (
  id integer NOT NULL GENERATED BY DEFAULT AS IDENTITY,
  report_id integer,
  file_url text NOT NULL,
  file_type character varying CHECK (file_type::text = ANY (ARRAY['image'::character varying, 'video'::character varying, 'document'::character varying]::text[])),
  uploaded_at timestamp with time zone DEFAULT now(),
  CONSTRAINT report_attachments_pkey PRIMARY KEY (id),
  CONSTRAINT report_attachments_report_id_fkey FOREIGN KEY (report_id) REFERENCES public.reports(id)
);

-- Create report_tokens table
CREATE TABLE public.report_tokens (
  report_id integer NOT NULL,
  access_token character varying NOT NULL UNIQUE,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT report_tokens_pkey PRIMARY KEY (report_id),
  CONSTRAINT report_tokens_report_id_fkey FOREIGN KEY (report_id) REFERENCES public.reports(id)
);

-- Create function to auto-generate public_id
CREATE OR REPLACE FUNCTION generate_public_id()
RETURNS TRIGGER AS $$
BEGIN
    NEW.public_id := 'RPT-' || lpad(NEW.id::text, 6, '0');
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Create trigger for public_id generation
CREATE TRIGGER trigger_generate_public_id
    BEFORE INSERT ON public.reports
    FOR EACH ROW
    EXECUTE FUNCTION generate_public_id();
```

3. Click "Run" to execute the SQL

## Step 3: Set Up Storage for File Uploads

1. Go to "Storage" in your Supabase dashboard
2. Click "Create a new bucket"
3. Name: `report-attachments`
4. Set as Public bucket: Yes
5. Click "Create bucket"

## Step 4: Configure Row Level Security (RLS)

1. Go to "Authentication" > "Policies"
2. For the `reports` table, create these policies:

### Allow INSERT for anonymous users:
```sql
CREATE POLICY "Allow public report creation" ON public.reports
FOR INSERT TO anon
WITH CHECK (true);
```

### Allow SELECT for authenticated users (admin):
```sql
CREATE POLICY "Allow admin to view reports" ON public.reports
FOR SELECT TO authenticated
USING (true);
```

### For storage bucket:
```sql
-- Allow public to upload files
CREATE POLICY "Allow public uploads" ON storage.objects
FOR INSERT TO anon
WITH CHECK (bucket_id = 'report-attachments');

-- Allow public to view files
CREATE POLICY "Allow public access" ON storage.objects
FOR SELECT TO anon
USING (bucket_id = 'report-attachments');
```

## Step 5: Get Your Project Credentials

1. Go to "Settings" > "API"
2. Copy the following values:
   - Project URL
   - anon/public key

## Step 6: Configure Your Application

1. Open `jscript/supabaseClient.js` in your project
2. Replace the placeholder values:

```javascript
const SUPABASE_URL = 'YOUR_PROJECT_URL_HERE';
const SUPABASE_ANON_KEY = 'YOUR_ANON_KEY_HERE';
```

## Step 7: Create Your First Admin User

1. In the Supabase SQL Editor, run:

```sql
INSERT INTO public.admin (email, role) 
VALUES ('your-email@example.com', 'admin');
```

## Step 8: Test Your Application

1. Open `pages/landingPage.html` in your browser
2. Try submitting a report through `pages/reportPage.html`
3. Check the admin dashboard at `pages/adminPage.html`

## Optional: Environment Variables

For better security, you can use environment variables:

1. Create a `.env` file in your project root:
```
SUPABASE_URL=your_project_url
SUPABASE_ANON_KEY=your_anon_key
```

2. Use a build tool like Vite or webpack to inject these variables

## Troubleshooting

### Common Issues:

1. **CORS Errors**: Make sure your Supabase project allows your domain
2. **RLS Errors**: Check that your Row Level Security policies are correctly set
3. **File Upload Errors**: Verify storage bucket permissions

### Development Tips:

1. Use the Supabase dashboard to monitor database activity
2. Check the browser console for JavaScript errors
3. Use the Network tab to debug API calls

## Production Deployment

When deploying to production:

1. Update CORS settings in Supabase
2. Consider using authenticated users instead of anonymous
3. Set up proper backup and monitoring
4. Use environment variables for sensitive data

---

### 4. Configure Row Level Security (RLS) Policies

**Important**: You need to set up RLS policies to allow public access for report submission.

In the Supabase SQL Editor, run these commands:

```sql
-- Enable RLS on reports table
ALTER TABLE reports ENABLE ROW LEVEL SECURITY;

-- Allow public users to insert reports (for report submission)
CREATE POLICY "Allow public insert on reports" ON reports
FOR INSERT TO anon
WITH CHECK (true);

-- Allow public users to read their own reports (optional, for tracking)
CREATE POLICY "Allow public select on reports" ON reports
FOR SELECT TO anon
USING (true);

-- Enable RLS on report_attachments table
ALTER TABLE report_attachments ENABLE ROW LEVEL SECURITY;

-- Allow public users to insert attachments
CREATE POLICY "Allow public insert on report_attachments" ON report_attachments
FOR INSERT TO anon
WITH CHECK (true);

-- Allow public users to read attachments
CREATE POLICY "Allow public select on report_attachments" ON report_attachments
FOR SELECT TO anon
USING (true);

-- Enable RLS on report_tokens table
ALTER TABLE report_tokens ENABLE ROW LEVEL SECURITY;

-- Allow public users to insert tokens
CREATE POLICY "Allow public insert on report_tokens" ON report_tokens
FOR INSERT TO anon
WITH CHECK (true);

-- Allow public users to read tokens for tracking
CREATE POLICY "Allow public select on report_tokens" ON report_tokens
FOR SELECT TO anon
USING (true);

-- Admin table policies (restrict to authenticated users only)
ALTER TABLE admin ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Allow authenticated users to read admin" ON admin
FOR SELECT TO authenticated
USING (true);
```

### 5. Configure Storage Policies

For file uploads, you also need to configure storage bucket policies:

```sql
-- Allow public users to upload files
INSERT INTO storage.buckets (id, name, public) VALUES ('report-attachments', 'report-attachments', true);

-- Create storage policies
CREATE POLICY "Allow public uploads" ON storage.objects
FOR INSERT TO anon
WITH CHECK (bucket_id = 'report-attachments');

CREATE POLICY "Allow public downloads" ON storage.objects
FOR SELECT TO anon
USING (bucket_id = 'report-attachments');
```

### 6. Test the Configuration

After setting up the policies:

1. Go to your report submission page
2. Try submitting a test report
3. Check the reports table in Supabase to confirm it was inserted
4. Verify that files can be uploaded (if you test with attachments)

**Troubleshooting RLS Issues:**

If you still get RLS errors, you can temporarily disable RLS for testing:

```sql
-- TEMPORARY: Disable RLS for testing (NOT recommended for production)
ALTER TABLE reports DISABLE ROW LEVEL SECURITY;
ALTER TABLE report_attachments DISABLE ROW LEVEL SECURITY;
ALTER TABLE report_tokens DISABLE ROW LEVEL SECURITY;
```

**Re-enable RLS after confirming everything works:**

```sql
-- Re-enable RLS (recommended for production)
ALTER TABLE reports ENABLE ROW LEVEL SECURITY;
ALTER TABLE report_attachments ENABLE ROW LEVEL SECURITY;
ALTER TABLE report_tokens ENABLE ROW LEVEL SECURITY;
```

Your DaangMatino application is now fully integrated with Supabase! Users can submit reports, and admins can view them in real-time through the dashboard.
